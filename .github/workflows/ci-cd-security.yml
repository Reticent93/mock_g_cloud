name: Secure Build, Test, and Scan Pipeline

on:
  push:
    # Trigger the pipeline on a push to the main branch
    branches: [ "main" ]
  pull_request:
    # Trigger the pipeline on every Pull Request
    branches: [ "main" ]
  workflow_dispatch: # Allows manual trigger

permissions:
  id-token: write # REQUIRED for OIDC
  contents: read

jobs:
  # Job 1: Build and Test
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

  # Job 2: Security Scans
  security-scan:
    runs-on: ubuntu-latest
    needs: build-and-test
    permissions:
      contents: read
      security-events: write
      actions: read
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: CodeQL Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: javascript

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

      - name: Run Checkov Scan (for Terraform)
        uses: bridgecrewio/checkov-action@v1
        with:
          directory: environment/dev
          soft_fail: true

  # Job 3: Deploy to AWS (Continuous Delivery)
  deploy:
    runs-on: ubuntu-latest
    needs: security-scan
    environment: dev
    permissions:
      id-token: write
      contents: read

    # Only run this job when pushing to the main branch, not on PRs
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Debug - List Files
        run: ls -R

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          # Use a version matching local setup
          terraform_version: 1.12.2


      - name: Debug OIDC Token Claims
        run: |
          curl -sH "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
          "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=sts.amazonaws.com" | \
          jq -R 'split(".") | .[1] | @base64d | fromjson | {sub, aud}'
      # 1. Configure AWS Credentials (OIDC)
      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_DEPLOY_ROLE_ARN }}
          aws-region: us-west-2
          role-session-name: GitHubActions-${{github.run_id}}


      # 2a. Terraform Init NETWORK LAYER
      - name: Terraform Network
        working-directory: environment/dev/network
        run: |
          terraform init -backend-config="bucket=${{ secrets.STATE_BUCKET_NAME }}"
          terraform apply -auto-approve -var-file="terraform.tfvars"

      # 2b. Terraform Init BASE LAYER
      - name: Terraform Base
        working-directory: environment/dev/base
        run: |
          terraform init -backend-config="bucket=${{ secrets.STATE_BUCKET_NAME }}"
          terraform apply -auto-approve -var-file="terraform.tfvars"  

      # 2c. Terraform Init APP LAYER
      - name: Terraform App
        working-directory: environment/dev/app
        run: |
          terraform init -backend-config="bucket=${{ secrets.STATE_BUCKET_NAME }}"
          terraform apply -auto-approve -var-file="terraform.tfvars"    

